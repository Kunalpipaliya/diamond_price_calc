<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Valuation & Rapaport Calculator | Inventory Tool</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2.5rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h1 { font-size: 1.5rem; text-align: center; margin-bottom: 1.5rem; color: #0f172a; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box; }
        button { width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-main { background: var(--primary); color: white; margin-top: 1rem; }
        .btn-main:hover { background: #1d4ed8; }
        .btn-sec { background: #e2e8f0; color: #475569; margin-top: 0.5rem; }
        #resultBox { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; background: #eff6ff; display: none; text-align: center; border: 1px solid #bfdbfe; }
        .error-msg { color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem; display: none; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>Diamond Valuation Tool</h1>
    
    <div class="form-group">
        <label>Carat Weight (ct)</label>
        <input type="number" id="weight" step="0.01" placeholder="e.g. 1.05" autofocus>
    </div>

    <div class="form-group">
        <label>Color Grade</label>
        <select id="color">
            <option>D</option><option>E</option><option>F</option><option>G</option><option>H</option>
            <option>I</option><option>J</option><option>K</option><option>L</option><option>M</option>
        </select>
    </div>

    <div class="form-group">
        <label>Clarity Grade</label>
        <select id="clarity">
            <option>IF</option><option>VVS1</option><option>VVS2</option><option>VS1</option><option>VS2</option>
            <option>SI1</option><option>SI2</option><option>SI3</option><option>I1</option><option>I2</option><option>I3</option>
        </select>
    </div>

    <button class="btn-main" onclick="runCalculation()">Calculate & Save Entry</button>
    <button class="btn-sec" onclick="openExcel()">üìÇ Open Inventory Excel</button>

    <div id="errorBox" class="error-msg"></div>

    <div id="resultBox">
        <div style="font-size: 0.875rem; color: #64748b;">Rate: <span id="rateVal" style="font-weight: bold; color: var(--primary);"></span>/ct</div>
        <div style="font-size: 1.25rem; font-weight: 800; margin-top: 0.25rem;">Total: <span id="totalVal"></span></div>
        <div id="excelWarning" style="color: #ea580c; font-size: 0.75rem; margin-top: 0.5rem; display: none;">‚ö†Ô∏è Close Excel to save next entry!</div>
    </div>
</div>

<script>
    async function runCalculation() {
        const weightInput = document.getElementById('weight');
        const errBox = document.getElementById('errorBox');
        const resBox = document.getElementById('resultBox');
        
        errBox.style.display = 'none';

        const payload = {
            weight: weightInput.value,
            color: document.getElementById('color').value,
            clarity: document.getElementById('clarity').value
        };

        try {
            const response = await fetch('/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();

            if (data.success) {
                document.getElementById('rateVal').innerText = "$" + data.rate.toLocaleString();
                document.getElementById('totalVal').innerText = "$" + data.total.toLocaleString();
                document.getElementById('excelWarning').style.display = (data.saved === "LOCKED") ? "block" : "none";
                resBox.style.display = 'block';
                
                // RESET AND FOCUS FOR NEXT ENTRY
                weightInput.value = "";
                weightInput.focus();
            } else {
                errBox.innerText = data.error;
                errBox.style.display = 'block';
                resBox.style.display = 'none';
            }
        } catch (e) {
            alert("Server not responding. Ensure Python is running.");
        }
    }

    async function openExcel() {
        await fetch('/open-file');
    }
</script>
</body>
</html>